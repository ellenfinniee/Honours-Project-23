---
title: "Data cleaning/exploration"
output: html_document
date: "2024-04-05"
---

```{r setup}
library(tidyverse)
library(readxl)
library(writexl)
library(sf)
library(ggplot2)
library(leaflet)
library(tmap)
library(plotly)
library(ggthemes)
library(osmdata)
library(ggmap)
library(mapview)
library(openair)
library(openairmaps)
library(htmltools)
library(latex2exp)
library(cowplot)
```

```{r bus scores}
#get all bus scores into table
bus_scores <- read_excel("/Users/ellenfinnie/Documents/Uni/4th year/Project/diss/bus_accessibility.xlsx",col_names=c("ref_area_url","ref_area","weekday_score","weekend_score"),skip=8)

#find data zone codes for dundee only
dundee_zones <- read_excel("/Users/ellenfinnie/Documents/Uni/4th year/Project/diss/DataZone2011lookup.xlsx",col_names=c("DataZone","city"),skip=1) |>
  filter(city=='Dundee City')

#remove the data zone code from the corresponding URL
bus_scores['DataZone']<- NA
for(i in 1:6976){
  bus_scores[i,5]=substr(bus_scores[i,1], 53,61)
}

#merge bus scores with dundee datazones, remove all non-dundee zones
bus_scores_dundee<-merge(x = bus_scores, y = dundee_zones, by = "DataZone", all = TRUE) |>
  na.omit()

# make temp file, unzip folder and save into temp file
temp <- tempfile()
ZFile <- "/Users/ellenfinnie/Documents/Uni/4th year/Project/diss/SG_DataZoneBdry_2011.zip"
unzip(zipfile = ZFile, exdir = temp)

data_zones<-read_sf(temp)

#merge shape file with data zones, remove any non-dundee shape data
merged_data<-merge(x = data_zones, y = bus_scores_dundee, by = "DataZone", all = TRUE) |> 
  na.omit()

```

```{r initial import of air quality data and CSV creation}
# NOTE this is included as an example, very slow to run and CSV files are already available in git repo
codes <- aq_locations |> distinct(code) |> mutate_all(.funs = tolower)
aq_data <- importSAQN(site = codes$code, year = 2019)
write_csv(aq_data, "aq_data.csv")

```



```{r map plots (figs 5.1 and 8.1)}
# Plot monitor locations in the city
mapView(monitor_locations, map.types="OpenStreetMap",
          layer.name="Air Quality Monitors", legend=TRUE,cex=20)

# Generate plot of all bus scores in Dundee with added markers to reflect positions of air quality monitors
mapView(merged_data, map.types="OpenStreetMap", layer.name="Bus Scores", zcol = "weekday_score", legend.pos="bottomright", zoom=10)+
  mapView(monitor_locations, map.types="OpenStreetMap",
          layer.name="Air Quality Monitors", col.regions="white",color="white", legend=FALSE)

```
